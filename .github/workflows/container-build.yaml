name: "Build and deploy container"
on:
    workflow_dispatch:
        inputs:
            cf_env:
                description: Choose environment
                type: choice
                required: true
                options:
                    - dev
                    - staging
                    - prod
                default: dev
            branch:
                description: Choose branch or tag, defaults to container
                type: string
                required: true
                default: container
            preCommand:
                description: Provide a bash script to execute before running wrangler
                type: string
                required: false
                default: echo "No script provided for execution before running Wrangler. Moving along."
            postCommand:
                description: Provide a bash script to execute after running wrangler
                type: string
                required: false
                default: echo "Nothing to execute after running Wrangler. Finishing..."
            emsdk_version:
                description: Emscripten SDK version, defaults to 4.0.20
                type: string
                required: false
                default: "4.0.20"
            custom_domain:
                description: Custom domain for the worker - leave empty to skip
                type: string
                required: false
                default: ""
jobs:
    deploy:
        runs-on: "ubuntu-latest"
        steps:
            - name: Checkout
              uses: actions/checkout@v6
              with:
                  ref: ${{ inputs.branch }}
                  submodules: 'true'

            - name: Set environment variables
              run: |
                  if [[ "${{ inputs.cf_env }}" == "dev" ]]; then
                    echo "CF_ACCOUNT=DEV_ACCOUNT_ID" >> "$GITHUB_ENV"
                    echo "CF_TOKEN=JITSI_CF_DEV_TOKEN" >> "$GITHUB_ENV"
                  elif [[ "${{ inputs.cf_env }}" == "staging" ]]; then
                    echo "CF_ACCOUNT=STAGE_ACCOUNT_ID" >> "$GITHUB_ENV"
                    echo "CF_TOKEN=JITSI_CF_STAGING_TOKEN" >> "$GITHUB_ENV"
                  elif [[ "${{ inputs.cf_env }}" == "prod" ]]; then
                    echo "CF_ACCOUNT=PROD_ACCOUNT_ID" >> "$GITHUB_ENV"
                    echo "CF_TOKEN=JITSI_CF_PROD_TOKEN" >> "$GITHUB_ENV"
                  else
                    echo "Invalid environment specified: ${{ inputs.cf_env }}, exiting."
                    exit 1
                  fi

            - name: Install Linux deps
              run: |
                sudo apt update
                sudo apt -y install wget unzip

            - uses: actions/setup-node@v4
              with:
                  node-version: 22
                  cache: npm

            - name: Install Node Dependencies
              run: |
                  npm ci

            - name: Setup Emscripten SDK
              run: |
                wget https://github.com/emscripten-core/emsdk/archive/main.zip
                unzip main.zip
                cd emsdk-main
                ./emsdk install ${{ inputs.emsdk_version }}
                ./emsdk activate ${{ inputs.emsdk_version }}
                source ./emsdk_env.sh
                echo "EMSDK=$EMSDK" >> $GITHUB_ENV
                echo "EM_CONFIG=$EM_CONFIG" >> $GITHUB_ENV
                echo "$EMSDK:$EMSDK/upstream/emscripten" >> $GITHUB_PATH

            - name: Build WASM modules
              run: |
                source "$EMSDK/emsdk_env.sh"
                npm run build:wasm

            - name: Build main worker
              run: |
                  npm run build

            - name: Install Worker Container Dependencies
              working-directory: worker
              run: |
                  npm ci

            - name: Configure Custom Domain
              if: ${{ inputs.custom_domain != '' }}
              run: |
                  echo "Configuring custom domain: ${{ inputs.custom_domain }}"

                  # Create a temporary Python script to modify the JSON
                  cat > modify_wrangler.py << 'EOF'
                  import json
                  import sys

                  domain = sys.argv[1]

                  # Read wrangler.jsonc (strip comments)
                  with open('wrangler.jsonc', 'r') as f:
                      content = f.read()

                  # Remove single-line comments
                  lines = []
                  for line in content.split('\n'):
                      # Keep line if it doesn't start with // (after stripping whitespace)
                      stripped = line.strip()
                      if not stripped.startswith('//'):
                          lines.append(line)

                  clean_content = '\n'.join(lines)

                  # Parse JSON
                  config = json.loads(clean_content)

                  # Add routes configuration
                  config['routes'] = [
                      {
                          'pattern': f'{domain}/*',
                          'custom_domain': True
                      }
                  ]

                  # Write back as JSON (no comments)
                  with open('wrangler.json', 'w') as f:
                      json.dump(config, f, indent=2)

                  print(f"âœ… Added custom domain route: {domain}/*")
                  EOF

                  python3 modify_wrangler.py "${{ inputs.custom_domain }}"

                  echo "Modified wrangler.json (routes section):"
                  jq '.routes' wrangler.json

            - name: Wrangler Deploy
              uses: cloudflare/wrangler-action@v3
              with:
                  wranglerVersion: "4.51.0"
                  apiToken: ${{ secrets[env.CF_TOKEN] }}
                  accountId: ${{ secrets[env.CF_ACCOUNT] }}
                  preCommands: ${{ inputs.preCommand }}
                  postCommands: ${{ inputs.postCommand }}
                  command: deploy --config ${{ inputs.custom_domain != '' && 'wrangler.json' || 'wrangler.jsonc' }}

            - name: Upload Wrangler Logs
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: wrangler-logs-${{ github.run_id }}
                  path: /home/runner/.config/.wrangler/logs/
                  retention-days: 7
                  if-no-files-found: ignore
